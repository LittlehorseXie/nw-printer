<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <title>万象集</title>
  </head>
  <body>
    <iframe id="frame" width="100%" height="100%" frameborder="0" frameborder="0"
      src="http://gz-sems-development01.gz.sftcwl.com:8291/manage/login?url=/pages/merchant/list"></iframe>
    <script>
      var win = nw.Window.get()
      var frame = document.getElementById('frame')
      frame.height = win.height
      win.on('resize', function(){
        frame.height = win.height
      })
      const domain = 'http://gz-sems-development01.gz.sftcwl.com:8291'
      
      
      var pkg = require('./package.json')
      frame.src = `http://gz-sems-development01.gz.sftcwl.com:8291/manage/login?url=/pages/merchant/list&version=${pkg.version}&isnw=1`

      const printer = require('./printer.js')
      
      function getPrinterList() {
        const list = printer.getPrinterList()
        const res = []
        list.forEach(item => res.push(item.name))
        return res
      }

      function getPrinter() {
        var list = document.cookie.split(';')
        for(var i = 0; i < list.length; i++) {
          var arr = list[i].split('=')
          if(arr.length === 2 && arr[0] === 'ae-printer') {
            // if (printer.getPrinter('939939')) {
            //   return false
            // }
            return arr[1]
          }
        }
        return false
      }
      function setPrinter(name) {
        document.cookie = `ae-printer=${name}`
      }
      
      window.addEventListener('message', function(e) {
        const data = JSON.parse(e.data)
        if (data.type === 'getPrinter') {
          console.log('getPrinter')
          const res = getPrinter()
          if (res) {
            frame.contentWindow.postMessage(JSON.stringify({type: 'setPrinterName', name: res}), domain)
          } else {
            frame.contentWindow.postMessage(JSON.stringify({type: 'setPrinterName'}), domain)
          }
          
        } else if (data.type === 'print') {
          console.log('print', data.name, data.data)
          printOrderRecive(data.name, data.data)
        } else if (data.type === 'setPrinter') {
          console.log('setPrinter', data.name)
          setPrinter(data.name)
          const res = getPrinter()
          frame.contentWindow.postMessage(JSON.stringify({type: 'setPrinterName', name: data.name}), domain)
        } else if (data.type === 'getPrinterList') {
          console.log('getPrinterList')
          const list = getPrinterList()
          frame.contentWindow.postMessage(JSON.stringify({type: 'setPrinterList', list}), domain)
        }
      })

      function printOrderRecive(name, data) {
        console.log(name, data)
        const Buffer = require('./escpos.js')
        var buffer = new Buffer()

        buffer = buffer.setLineHeight(70)
          .setTextSize(2).setLineHeight(50).setText(data.id, 'center')
          .setTextSize(1).setLineHeight(100).setText(`${data.delivery_way} ${data.deliver_time}`, 'center')
          .setLineHeight(70).setDecLine()
          .setBoldOn()
          .setLineHeight(70)
        data.sku_detail.forEach(item => {
          buffer = buffer.setThreeCol(item.quantity, item.sku_name, `￥${item.price}`)
        })
        buffer = buffer.setLine()
          .setLineHeight(100).setText(`备注：${data.description}`).setBoldOff()
          .setLineHeight(50).setDecLine()
          .setLineHeight(70)
          .setTwoCol('开具发票', data.invoiced)
          .setTwoCol('包装费', `￥${data.package_fee}`)
          .setTwoCol('配送费', `￥${data.deliver_fee}`)
          .setLineHeight(50)
          .setDecLine()
          .setBoldOn().setText(`合计：￥${data.total_price}  `, 'right').setBoldOff()
          .setDecLine()
          .setLineHeight(70)
          .setText(`送货地址：${data.receiver_address}`)
          .setText(`客户：${data.receiver_name} ${data.receiver_phone}`)
          .setDecLine()
          .setText(`下单时间: ${data.create_time} \n \n`, 'center')
          .setLine().setLine()
          .setBoldOn().setText(data.tagg_shop_name, 'center')
          .setLine().setLine()
          .cut()
          .getBuffer()
          
          printer.print(name, buffer)
      }
    </script>
  </body>
</html>